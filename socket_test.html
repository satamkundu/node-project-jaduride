<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <style>
        .heading{
            display: inline;
            width: fit-content;
        }
        .link{
            width: fit-content;
            height: fit-content;
        }
        .block {
            /* height: 425px; */
            max-width: 35rem;
            padding-top: 15px;  
            /* margin-top: 7rem; */
            border: solid 1px;
            border-radius: 5px;
        }  
        .block2 {
            min-height: 160px;
            padding-top: 15px; 
        } 

        .center {
            margin: auto;  
        }

        #messages{
            font-size: smaller;
        }
    </style>
</head>

<body>
    <div class="container col-lg-12 mt-2 block">        
        <div class="row col-xs-6 block2 center">
            <h1 class="heading">WebSocket Client</h1>
            <a href="http://localhost:3000/auth/generateToken" target="_blank" class="btn btn-dark link">Generate Token</a>
            
            <input class="form-control mb-2" type="text" id="keyInput" placeholder="Key..."  value="token"/>
            <textarea class="form-control" type="text" id="tokenInput" placeholder="Provide token..." rows="6" autofocus></textarea>
            
            <button class="btn btn-primary mt-2 mb-2" id="btn-send" onclick="sendMessage()">Send</button>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let ws;

        function connect() {
            ws = new WebSocket('ws://localhost:3000');

            ws.onopen = () => { // Connection opened
                console.log('Connected to server');
                addMessage('Connected to server')
            };

            ws.onmessage = (event) => { // Listen for messages
                const data = JSON.parse(event.data)

                if(typeof data === "object"){
                    addMessage(JSON.stringify(data))
                }else{
                    addMessage(data)
                    enableButton()
                }
            };

            ws.onclose = () => { // Connection closed
                console.log('Disconnected from server');
                addMessage('Disconnected from server...');
                enableButton()
            };

            ws.onerror = (error) => { // Handle errors
                console.error('WebSocket error:', error);
                addMessage(`Error: Server may be not responding, please try after sometime later...`);
                enableButton()
            };
        }

        function sendMessage() {  // Send message to server
            const keyInput = document.getElementById('keyInput');
            const token_field = document.getElementById('tokenInput');
            
            const key = keyInput.value;
            const token = token_field.value

            if (ws.readyState === WebSocket.OPEN) {
                document.getElementById("btn-send").setAttribute("disabled", ""); 
                ws.send(JSON.stringify({
                    event : "message",
                    data : {
                        [key] : token
                    }
                }));
            }else {
                addMessage('Connection is not open. Message not sent.');
            }
        }

        function addMessage(message) { // Add message to display
            document.getElementById('messages').innerHTML += message + "<br>"
        }
    
        function enableButton(buttonId = "btn-send"){
            document.getElementById(buttonId).removeAttribute("disabled"); 
        }
        connect()
    </script>
</body>

</html>